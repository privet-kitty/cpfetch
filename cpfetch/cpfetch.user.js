// ==UserScript==
// @name        cpfetch
// @version     0.3.0
// @author      Hugo Sansaqua
// @description Userscript for competitive programming: parse test cases and copy template to clipboard on various online judges
// @homepage    https://github.com/privet-kitty/cpfetch
// @match       https://atcoder.jp/*/tasks/*
// @match       https://*.atcoder.jp/tasks/*
// @match       https://*.codechef.com/*/problems/*
// @match       https://*.codechef.com/problems/*
// @match       https://yukicoder.me/problems/*
// @match       https://toph.co/p/*
// @match       https://toph.co/arena*
// @match       https://csacademy.com/contest/*/task/*
// @namespace   https://privet-kitty.github.io/
// @grant       GM_setClipboard
// @grant       GM_registerMenuCommand
// @grant       GM_getResourceText
// @resource    template https://raw.githubusercontent.com/privet-kitty/cl-competitive/master/non-module/template.lisp
// @resource    modOperations https://raw.githubusercontent.com/privet-kitty/cl-competitive/master/module/mod-operations.lisp
// @resource    increaseStack https://raw.githubusercontent.com/privet-kitty/cl-competitive/master/non-module/increase-space.lisp
// ==/UserScript==

(()=>{"use strict";var e={714:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.siteAtCoder=void 0;const o=n(601),r=n(882),l=(e,t)=>{if(null===e)return!1;const n=document.createElement("button");return n.id=o.COPY_BUTTON_ID,n.classList.add("btn","btn-default","btn-sm"),n.innerHTML=o.COPY_BUTTON_LABEL,n.addEventListener("click",t),e.appendChild(n),!0};t.siteAtCoder={domain:"atcoder.jp",findTestCases:e=>{const t=e.cloneNode(!0);t.querySelectorAll(".div-btn-copy").forEach((e=>e.parentNode?.removeChild(e))),t.querySelectorAll(".btn-copy").forEach((e=>e.parentNode?.removeChild(e)));const n=[],o=[];return t.querySelectorAll("h3").forEach((e=>{if(null===e.textContent)return;const t=e.textContent.normalize("NFKC");if(/^.*(入力例|Sample Input)\s*[0-9]*\s*$/.test(t)){const t=e.parentNode?.querySelector("pre")?.textContent;null!=t&&n.push(r.prettify(t))}if(/^.*(出力例|Sample Output)\s*[0-9]*\s*$/.test(t)){const t=e.parentNode?.querySelector("pre")?.textContent;null!=t&&o.push(r.prettify(t))}})),n.length===o.length?r.deleteDuplicateTestCases(r.zip(n,o)):(console.log("Failed to parse test cases."),[])},addCopyButton:(e,t)=>{l(e.querySelector(".h2"),t)||l(e.querySelector("h2"),t)}}},991:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.siteCodeChef=void 0;const o=n(601),r=n(882),l=(e,t)=>{if(null===e)return!1;if(void 0===e.parentNode||null===e.parentNode)return!1;const n=document.createElement("button");return n.id=o.COPY_BUTTON_ID,n.innerHTML=o.COPY_BUTTON_LABEL,n.classList.add("button","grey"),n.addEventListener("click",t),e.parentNode.insertBefore(n,e.nextSibling),!0};t.siteCodeChef={domain:"codechef.com",findTestCases:e=>{const t=[],n=[];e.querySelectorAll("h3#exampleinput, h3#sampleinput").forEach((e=>{const n=e.nextElementSibling?.textContent;null!=n&&t.push(r.prettify(n))})),e.querySelectorAll("h3#exampleoutput, h3#sampleoutput").forEach((e=>{const t=e.nextElementSibling?.textContent;null!=t&&n.push(r.prettify(t))}));for(let o=1;o<1e3;o++){const l=e.getElementById(`exampleinput${o}`)?.nextElementSibling?.textContent,s=e.getElementById(`exampleoutput${o}`)?.nextElementSibling?.textContent;if(!l||!s)break;t.push(r.prettify(l)),n.push(r.prettify(s))}return t.length===n.length?r.zip(t,n):(console.log("Failed to parse test cases."),[])},addCopyButton:(e,t)=>{e.querySelectorAll("h1:not(.left)").forEach((e=>l(e,t)))},isReady:e=>e.querySelectorAll("h1:not(.left)").length>0,isIncreaseStack:!0}},601:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.COPY_BUTTON_LABEL=t.COPY_BUTTON_ID=void 0,t.COPY_BUTTON_ID="cpfetchCopyButton",t.COPY_BUTTON_LABEL="Copy template to clipboard"},59:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.siteCsAcademy=void 0;const o=n(601),r=n(882),l=(e,t)=>{if(null===e)return!1;if(null===e.parentNode)return!1;const n=document.createElement("button");return n.id=o.COPY_BUTTON_ID,n.innerHTML=o.COPY_BUTTON_LABEL,n.addEventListener("click",t),e.parentNode.insertBefore(n,e.nextSibling),!0};t.siteCsAcademy={domain:"csacademy.com",findTestCases:e=>{const t=[],n=[],o=e.querySelectorAll("thead tr th");if("Input"===o[0].innerText&&"Output"===o[1].innerText){const e=o[0]?.parentNode?.parentNode;e instanceof Element&&e.nextElementSibling?.childNodes?.forEach((e=>{const[o,l]=e.childNodes;o instanceof HTMLElement&&l instanceof HTMLElement&&(t.push(r.prettify(o.innerText)),n.push(r.prettify(l.innerText)))}))}return console.log(t,n),t.length>0&&t.length===n.length?r.zip(t,n):(console.log("Failed to parse test cases."),[])},addCopyButton:(e,t)=>{e.querySelectorAll("h1").forEach((e=>l(e,t)))},isReady:e=>{const t=e.querySelectorAll("thead tr th");return void 0!==t&&t.length>=2&&t[0]instanceof HTMLElement&&"Input"===t[0].innerText&&t[1]instanceof HTMLElement&&"Output"===t[1].innerText}}},607:(e,t,n)=>{const o=n(754),r=n(714),l=n(991),s=n(62),i=n(59),c=n(848),u=new URL(document.URL).hostname;[r.siteAtCoder,l.siteCodeChef,s.siteYukicoder,i.siteCsAcademy,c.siteToph].forEach((e=>{new RegExp(e.domain).test(u)&&o.setUpSite(e)}))},754:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.setUpSite=void 0;const o=n(601),r=n(882),l=({findTestCases:e,addCopyButton:t,isIncreaseStack:n})=>{if(null!==document.getElementById(o.COPY_BUTTON_ID))return void console.log("Copy button already exists.");const l=()=>{const t=e(document),o=n?GM_getResourceText("increaseStack"):"";GM_setClipboard(r.createTemplate(t,o)),console.log("copied")};t(document,l),GM_registerMenuCommand(o.COPY_BUTTON_LABEL,l,"c")};t.setUpSite=e=>{const{isReady:t}=e;void 0===t?l(e):new MutationObserver(((n,o)=>{t(document,n,o)&&(console.log("isReady() succeeded"),o.disconnect(),l(e))})).observe(document,{childList:!0,subtree:!0}),window.addEventListener("keydown",(t=>{"t"===t.key&&l(e)}))}},848:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.siteToph=void 0;const o=n(601),r=n(882),l=(e,t)=>{if(null===e)return!1;if(null===e.parentNode)return!1;const n=document.createElement("button");return n.id=o.COPY_BUTTON_ID,n.innerHTML=o.COPY_BUTTON_LABEL,n.classList.add("btn","default"),n.addEventListener("click",t),e.parentNode.insertBefore(n,e.nextSibling),!0};t.siteToph={domain:"toph.co",findTestCases:e=>{const t=[],n=[];for(let n=0;n<1e3;n++){const o=e.getElementById(`preSample${n}Input`);if(null===o)break;null!==o.textContent&&t.push(r.prettify(o.textContent))}for(let t=0;t<1e3;t++){const o=e.getElementById(`preSample${t}Output`);if(null===o)break;null!==o.textContent&&n.push(r.prettify(o.textContent))}return console.log(t,n),t.length===n.length?r.zip(t,n):(console.log("Failed to parse test cases."),[])},addCopyButton:(e,t)=>{e.querySelectorAll("h1").forEach((e=>{console.log(e.textContent),l(e,t)}))}}},882:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.zip=t.deleteDuplicateTestCases=t.prettify=t.createTemplate=t.findMod=t.formatTestForm=void 0,t.formatTestForm=e=>{const t=e=>e.replace('"','\\"');let n=";; To run: (5am:run! :sample)\n#+swank\n(5am:test :sample\n";return e.forEach((([e,o])=>{n+=((e,t)=>`  (5am:is\n   (equal "${t}"\n          (run "${e}" nil)))\n`)(t(e),t(o))})),"\n"===n[n.length-1]&&(n=n.slice(0,-1)),n+=")\n",n},t.findMod=e=>{const t=[],n=t=>t.some((t=>e.search(new RegExp("(^|[^\\d])"+t.source+"($|[^\\d])"))>=0));return n([/998,?244,?353/])?t.push(998244353):n([/163,?577,?857/])?t.push(163577857):n([/1,?000,?000,?007/,/10\^[\s{]*9[\s}]*\+[\s]*7/])?t.push(1000000007):n([/1,?000,?000,?009/,/10\^[\s{]*9[\s}]*\+[\s]*9/])?t.push(1000000009):n([/10,?007/])&&t.push(10007),1===t.length?t[0]:null};const n=(e,t,n)=>e.slice(0,n)+t+e.slice(n);t.createTemplate=(e,o)=>{const r=t.formatTestForm(e);return o+(e=>{const o=t.findMod(document.body.textContent??"");if(null===o)return e;{console.log(`Use ${o} as modulus`);let t=e.replace("1000000007",String(o));const r="BEGIN_INSERTED_CONTENTS",l=GM_getResourceText("modOperations")+"\n(define-mod-operations cl-user::+mod+ :cl-user)\n\n";t=n(t,l,t.search(r)+r.length+1);const s="BEGIN_USE_PACKAGE";return t=n(t,"(eval-when (:compile-toplevel :load-toplevel :execute)\n(use-package :cp/mod-operations :cl-user))\n",t.search(s)+s.length+1),t}})(GM_getResourceText("template")).replace("PROBLEM_URL_TO_BE_REPLACED",document.URL)+"\n"+r},t.prettify=e=>{const t=e.replace("/\r\n?/","\n").replace(/^\s+/,"").replace(/\s+$/,"");return 0===t.length||"\n"!==t[t.length-1]?t+"\n":t},t.deleteDuplicateTestCases=e=>{const t=[],n=new Set;return e.forEach((([e,o])=>{n.has(e)||(n.add(e),t.push([e,o]))})),t},t.zip=(e,t)=>e.map(((n,o)=>[e[o],t[o]]))},62:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.siteYukicoder=void 0;const o=n(601),r=n(882),l=(e,t)=>{if(null===e)return!1;const n=document.createElement("button");return n.id=o.COPY_BUTTON_ID,n.innerHTML=o.COPY_BUTTON_LABEL,n.addEventListener("click",t),e.parentNode?.insertBefore(n,e.nextSibling),!0};t.siteYukicoder={domain:"yukicoder.me",findTestCases:e=>{const t=[],n=[];return e.querySelectorAll("h6").forEach((e=>{if(null===e.textContent)return;const o=e.textContent.normalize("NFKC");if(/入力/.test(o)){const n=e.nextElementSibling?.textContent;null!=n&&t.push(r.prettify(n))}if(/出力/.test(e.textContent)){const t=e.nextElementSibling?.textContent;null!=t&&n.push(r.prettify(t))}})),t.length===n.length?r.zip(t,n):(console.log("Failed to parse test cases."),[])},addCopyButton:(e,t)=>{e.querySelectorAll("h3").forEach((e=>{null!==e.textContent&&/No./.test(e.textContent)&&l(e,t)}))}}}},t={};!function n(o){if(t[o])return t[o].exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(607)})();